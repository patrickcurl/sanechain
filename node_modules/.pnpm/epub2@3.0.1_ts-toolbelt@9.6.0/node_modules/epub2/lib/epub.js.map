{"version":3,"file":"epub.js","sourceRoot":"","sources":["epub.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2020/6/10.\n */\n\nimport { EventEmitter } from \"events\";\nimport { IZipFile, ZipFile } from '../zipfile';\nimport xml2js from 'xml2js';\nimport { array_unique } from 'array-hyper-unique';\nimport { dirname as pathDirname, posix } from \"path\";\nimport { resolve as urlResolve } from \"url\";\nimport { crlf } from 'crlf-normalize';\n\nimport { SYMBOL_RAW_DATA } from './types';\nimport { isEpub } from './epub/isEpub';\nimport { IMetadata, IMetadataList, INcx, INcxTree, ISpine, ISpineContents, TocElement } from \"./epub/const\";\n\n/**\n *  new EPub(fname[, imageroot][, linkroot])\n *  - fname (String): filename for the ebook\n *  - imageroot (String): URL prefix for images\n *  - linkroot (String): URL prefix for links\n *\n *  Creates an Event Emitter type object for parsing epub files\n *\n *      var epub = new EPub(\"book.epub\");\n *      epub.on(\"end\", function () {\n *           console.log(epub.spine);\n *      });\n *      epub.on(\"error\", function (error) { ... });\n *      epub.parse();\n *\n *  Image and link URL format is:\n *\n *      imageroot + img_id + img_zip_path\n *\n *  So an image \"logo.jpg\" which resides in \"OPT/\" in the zip archive\n *  and is listed in the manifest with id \"logo_img\" will have the\n *  following url (providing that imageroot is \"/images/\"):\n *\n *      /images/logo_img/OPT/logo.jpg\n **/\nexport class EPub extends EventEmitter\n{\n\tmetadata: IMetadata;\n\tmanifest: IMetadataList;\n\tspine: ISpine;\n\tflow: ISpineContents;\n\ttoc: ISpineContents;\n\n\tncx: INcx;\n\tncx_depth: number;\n\n\tfilename: string;\n\timageroot: string;\n\tlinkroot: string;\n\n\tcontainerFile: string;\n\tmimeFile: string;\n\trootFile: string;\n\n\tzip: IZipFile;\n\n\tversion: string;\n\n\tprotected _getStatic()\n\t{\n\t\t// @ts-ignore\n\t\treturn this.__proto__.constructor;\n\t}\n\n\tconstructor(epubfile: string, imagewebroot?: string, chapterwebroot?: string, ...argv)\n\t{\n\t\tsuper();\n\n\t\tthis.filename = epubfile;\n\n\t\tthis.imageroot = (imagewebroot || this._getStatic().IMAGE_ROOT).trim();\n\t\tthis.linkroot = (chapterwebroot || this._getStatic().LINK_ROOT).trim();\n\n\t\tif (this.imageroot.substr(-1) != \"/\")\n\t\t{\n\t\t\tthis.imageroot += \"/\";\n\t\t}\n\t\tif (this.linkroot.substr(-1) != \"/\")\n\t\t{\n\t\t\tthis.linkroot += \"/\";\n\t\t}\n\t}\n\n\tstatic create(epubfile: string, imagewebroot?: string, chapterwebroot?: string, ...argv)\n\t{\n\t\tlet epub = new this(epubfile, imagewebroot, chapterwebroot, ...argv);\n\n\t\treturn epub;\n\t}\n\n\t/**\n\t *  EPub#parse() -> undefined\n\t *\n\t *  Starts the parser, needs to be called by the script\n\t **/\n\tpublic parse()\n\t{\n\t\tthis.containerFile = null;\n\t\tthis.mimeFile = null;\n\t\tthis.rootFile = null;\n\n\t\tthis.metadata = {};\n\t\tthis.manifest = {};\n\t\tthis.spine = { toc: null, contents: [] };\n\t\tthis.flow = [];\n\t\tthis.toc = [];\n\n\t\tthis.open();\n\n\t\treturn this;\n\t}\n\n\t/**\n\t *  EPub#open() -> undefined\n\t *\n\t *  Opens the epub file with Zip unpacker, retrieves file listing\n\t *  and runs mime type check\n\t **/\n\topen()\n\t{\n\t\ttry\n\t\t{\n\t\t\t// @ts-ignore\n\t\t\tthis.zip = new ZipFile(this.filename);\n\t\t}\n\t\tcatch (E)\n\t\t{\n\t\t\tthis.emit(\"error\", new Error(`Invalid/missing file ${this.filename}`));\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.zip.names || !this.zip.names.length)\n\t\t{\n\t\t\tthis.emit(\"error\", new Error(`No files in archive ${this.filename}`));\n\t\t\treturn;\n\t\t}\n\t\tthis.checkMimeType();\n\t}\n\n\t/**\n\t *  EPub#checkMimeType() -> undefined\n\t *\n\t *  Checks if there's a file called \"mimetype\" and that it's contents\n\t *  are \"application/epub+zip\". On success runs root file check.\n\t **/\n\tcheckMimeType()\n\t{\n\t\tvar i, len;\n\n\t\tfor (i = 0, len = this.zip.names.length; i < len; i++)\n\t\t{\n\t\t\tif (this.zip.names[i].toLowerCase() == \"mimetype\")\n\t\t\t{\n\t\t\t\tthis.mimeFile = this.zip.names[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (!this.mimeFile)\n\t\t{\n\t\t\tthis.emit(\"error\", new Error(\"No mimetype file in archive\"));\n\t\t\treturn;\n\t\t}\n\t\tthis.zip.readFile(this.mimeFile, (err, data) =>\n\t\t{\n\t\t\tif (err)\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Reading archive failed\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!isEpub(data, true))\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Unsupported mime type\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getRootFiles();\n\t\t});\n\t}\n\n\tprotected _Elem(element: TocElement)\n\t{\n\t\tconst SYMBOL_RAW_DATA = this._getStatic().SYMBOL_RAW_DATA;\n\n\t\tif (!element[SYMBOL_RAW_DATA])\n\t\t{\n\t\t\telement[SYMBOL_RAW_DATA] = Object.assign({}, element);\n\t\t}\n\n\t\tif (element['media-type'])\n\t\t{\n\t\t\telement['mediaType'] = element['media-type'];\n\t\t}\n\n\t\treturn element;\n\t}\n\n\t/**\n\t *  EPub#getRootFiles() -> undefined\n\t *\n\t *  Looks for a \"meta-inf/container.xml\" file and searches for a\n\t *  rootfile element with mime type \"application/oebps-package+xml\".\n\t *  On success calls the rootfile parser\n\t **/\n\tgetRootFiles()\n\t{\n\t\tvar i, len;\n\t\tfor (i = 0, len = this.zip.names.length; i < len; i++)\n\t\t{\n\t\t\tif (this.zip.names[i].toLowerCase() == \"meta-inf/container.xml\")\n\t\t\t{\n\t\t\t\tthis.containerFile = this.zip.names[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (!this.containerFile)\n\t\t{\n\t\t\tthis.emit(\"error\", new Error(\"No container file in archive\"));\n\t\t\treturn;\n\t\t}\n\n\t\tconst xml2jsOptions = this._getStatic().xml2jsOptions;\n\n\t\tthis.zip.readFile(this.containerFile,  (err, data) =>\n\t\t{\n\t\t\tif (err)\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Reading archive failed\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet xml = data.toString(\"utf-8\").toLowerCase().trim(),\n\t\t\t\txmlparser = new xml2js.Parser(xml2jsOptions);\n\n\t\t\tlet parser = xmlparser.on(\"end\", (result) =>\n\t\t\t{\n\n\t\t\t\tif (!result.rootfiles || !result.rootfiles.rootfile)\n\t\t\t\t{\n\t\t\t\t\tthis.emit(\"error\", new Error(\"No rootfiles found\"));\n\t\t\t\t\tconsole.dir(result);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvar rootfile = result.rootfiles.rootfile,\n\t\t\t\t\tfilename = false, i, len;\n\n\t\t\t\tif (Array.isArray(rootfile))\n\t\t\t\t{\n\n\t\t\t\t\tfor (i = 0, len = rootfile.length; i < len; i++)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (rootfile[i][\"@\"][\"media-type\"] &&\n\t\t\t\t\t\t\trootfile[i][\"@\"][\"media-type\"] == \"application/oebps-package+xml\" &&\n\t\t\t\t\t\t\trootfile[i][\"@\"][\"full-path\"])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfilename = rootfile[i][\"@\"][\"full-path\"].toLowerCase().trim();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t\telse if (rootfile[\"@\"])\n\t\t\t\t{\n\t\t\t\t\tif (rootfile[\"@\"][\"media-type\"] != \"application/oebps-package+xml\" || !rootfile[\"@\"][\"full-path\"])\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.emit(\"error\", new Error(\"Rootfile in unknown format\"));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tfilename = rootfile[\"@\"][\"full-path\"].toLowerCase().trim();\n\t\t\t\t}\n\n\t\t\t\tif (!filename)\n\t\t\t\t{\n\t\t\t\t\tthis.emit(\"error\", new Error(\"Empty rootfile\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfor (i = 0, len = this.zip.names.length; i < len; i++)\n\t\t\t\t{\n\t\t\t\t\tif (this.zip.names[i].toLowerCase() == (filename as any as string))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.rootFile = this.zip.names[i];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!this.rootFile)\n\t\t\t\t{\n\t\t\t\t\tthis.emit(\"error\", new Error(\"Rootfile not found from archive\"));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.handleRootFile();\n\n\t\t\t});\n\n\t\t\txmlparser.on(\"error\", (err) =>\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Parsing container XML failed\"));\n\t\t\t\treturn;\n\t\t\t});\n\n\t\t\txmlparser.parseString(xml);\n\n\t\t});\n\t}\n\n\t/**\n\t *  EPub#handleRootFile() -> undefined\n\t *\n\t *  Parses the rootfile XML and calls rootfile parser\n\t **/\n\thandleRootFile()\n\t{\n\t\tconst xml2jsOptions = this._getStatic().xml2jsOptions;\n\n\t\tthis.zip.readFile(this.rootFile, (err, data) =>\n\t\t{\n\t\t\tif (err)\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Reading archive failed\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar xml = data.toString(\"utf-8\"),\n\t\t\t\txmlparser = new xml2js.Parser(xml2jsOptions);\n\n\t\t\txmlparser.on(\"end\", this.parseRootFile.bind(this));\n\n\t\t\txmlparser.on(\"error\", (err) =>\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Parsing container XML failed\"));\n\t\t\t\treturn;\n\t\t\t});\n\n\t\t\txmlparser.parseString(xml);\n\n\t\t});\n\t}\n\n\t/**\n\t *  EPub#parseRootFile() -> undefined\n\t *\n\t *  Parses elements \"metadata,\" \"manifest,\" \"spine\" and TOC.\n\t *  Emits \"end\" if no TOC\n\t **/\n\tparseRootFile(rootfile)\n\t{\n\n\t\tthis.version = rootfile['@'].version || '2.0';\n\n\t\tvar i, len, keys, keyparts, key;\n\t\tkeys = Object.keys(rootfile);\n\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t{\n\t\t\tkeyparts = keys[i].split(\":\");\n\t\t\tkey = (keyparts.pop() || \"\").toLowerCase().trim();\n\t\t\tswitch (key)\n\t\t\t{\n\t\t\t\tcase \"metadata\":\n\t\t\t\t\tthis.parseMetadata(rootfile[keys[i]]);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"manifest\":\n\t\t\t\t\tthis.parseManifest(rootfile[keys[i]]);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"spine\":\n\t\t\t\t\tthis.parseSpine(rootfile[keys[i]]);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"guide\":\n\t\t\t\t\t//this.parseGuide(rootfile[keys[i]]);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this.spine.toc)\n\t\t{\n\t\t\tthis.parseTOC();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.emit(\"end\");\n\t\t}\n\t}\n\n\t/**\n\t *  EPub#parseMetadata() -> undefined\n\t *\n\t *  Parses \"metadata\" block (book metadata, title, author etc.)\n\t **/\n\tparseMetadata(metadata: IMetadata)\n\t{\n\t\tlet i, j, len, keys, keyparts, key;\n\t\tconst _self = this;\n\n\t\tthis.metadata[SYMBOL_RAW_DATA] = metadata;\n\n\t\tkeys = Object.keys(metadata);\n\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t{\n\t\t\tkeyparts = keys[i].split(\":\");\n\t\t\tkey = (keyparts.pop() || \"\").toLowerCase().trim();\n\n\t\t\tconst currentData = metadata[keys[i]];\n\n\t\t\tswitch (key)\n\t\t\t{\n\t\t\t\tcase \"publisher\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.publisher = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.publisher = String(currentData[\"#\"] || currentData || \"\").trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"language\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.language = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\n\t\t\t\t\t\tthis.metadata.language = String(currentData[\"#\"] || currentData || \"\")\n\t\t\t\t\t\t\t.toLowerCase()\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"title\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.title = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.title = String(currentData[\"#\"] || currentData || \"\").trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"subject\":\n\n\t\t\t\t\tthis.metadata.subject = this.metadata.subject || [];\n\n\t\t\t\t\t(Array.isArray(currentData) ? currentData : [currentData])\n\t\t\t\t\t\t.forEach(function (value)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet tag = (_meta_val(value, '#') || '').trim();\n\t\t\t\t\t\t\tif (tag !== '')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t_self.metadata.subject.push(tag);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"description\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.description = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.description = String(currentData[\"#\"] || currentData || \"\").trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"creator\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.creator = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t\tthis.metadata.creatorFileAs = String(currentData[0] && currentData[0]['@'] && currentData[0]['@'][\"opf:file-as\"] || this.metadata.creator)\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.creator = String(currentData[\"#\"] || currentData || \"\").trim();\n\t\t\t\t\t\tthis.metadata.creatorFileAs = String(currentData['@'] && currentData['@'][\"opf:file-as\"] || this.metadata.creator)\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"date\":\n\t\t\t\t\tif (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.date = String(currentData[0] && currentData[0][\"#\"] || currentData[0] || \"\")\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.date = String(currentData[\"#\"] || currentData || \"\").trim();\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"identifier\":\n\t\t\t\t\tif (currentData[\"@\"] && currentData[\"@\"][\"opf:scheme\"] == \"ISBN\")\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.ISBN = String(currentData[\"#\"] || \"\").trim();\n\t\t\t\t\t}\n\t\t\t\t\telse if (currentData[\"@\"] && currentData[\"@\"].id && currentData[\"@\"].id.match(/uuid/i))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata.UUID = String(currentData[\"#\"] || \"\")\n\t\t\t\t\t\t\t.replace('urn:uuid:', '')\n\t\t\t\t\t\t\t.toUpperCase()\n\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t}\n\t\t\t\t\telse if (Array.isArray(currentData))\n\t\t\t\t\t{\n\t\t\t\t\t\tfor (j = 0; j < currentData.length; j++)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (currentData[j][\"@\"])\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (currentData[j][\"@\"][\"opf:scheme\"] == \"ISBN\")\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.metadata.ISBN = String(currentData[j][\"#\"] || \"\").trim();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (currentData[j][\"@\"].id && currentData[j][\"@\"].id.match(/uuid/i))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.metadata.UUID = String(currentData[j][\"#\"] || \"\")\n\t\t\t\t\t\t\t\t\t\t.replace('urn:uuid:', '')\n\t\t\t\t\t\t\t\t\t\t.toUpperCase()\n\t\t\t\t\t\t\t\t\t\t.trim();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'meta':\n\t\t\t\t\tif (currentData['#'] && currentData['@'].property == 'calibre:author_link_map')\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.metadata['contribute'] = this.metadata['contribute'] || [];\n\t\t\t\t\t\tthis.metadata['author_link_map'] = this.metadata['author_link_map'] || {};\n\n\t\t\t\t\t\tlet t = JSON.parse(currentData['#']);\n\n\t\t\t\t\t\tfor (let n in t)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tn = n.toString().trim();\n\n\t\t\t\t\t\t\tthis.metadata['contribute'].push(n);\n\t\t\t\t\t\t\tthis.metadata['author_link_map'][n] = (t[n] || '').toString().trim();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.metadata['contribute'] = array_unique(this.metadata['contribute']);\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t//console.log(key, currentData);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tlet metas = metadata['meta'] || {};\n\t\tObject.keys(metas).forEach((key) =>\n\t\t{\n\t\t\tvar meta = metas[key];\n\t\t\tif (meta['@'] && meta['@'].name)\n\t\t\t{\n\t\t\t\tvar name = meta['@'].name;\n\t\t\t\tthis.metadata[name] = meta['@'].content;\n\n\t\t\t\tif (name == 'calibre:series')\n\t\t\t\t{\n\t\t\t\t\tthis.metadata['series'] = this.metadata['series'] || meta['@'].content;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (meta['#'] && meta['@'].property)\n\t\t\t{\n\t\t\t\tthis.metadata[meta['@'].property] = meta['#'];\n\t\t\t}\n\n\t\t\tif (meta.name && meta.name == \"cover\")\n\t\t\t{\n\t\t\t\tthis.metadata[meta.name] = meta.content;\n\t\t\t}\n\t\t}, this);\n\n\t\tfunction _meta_val(row, key = null)\n\t\t{\n\t\t\tif (key !== null)\n\t\t\t{\n\t\t\t\treturn row[key] || row;\n\t\t\t}\n\n\t\t\treturn row;\n\t\t}\n\t}\n\n\t/**\n\t *  EPub#parseManifest() -> undefined\n\t *\n\t *  Parses \"manifest\" block (all items included, html files, images, styles)\n\t **/\n\tparseManifest(manifest)\n\t{\n\t\tvar i, len, path = this.rootFile.split(\"/\"), element, path_str;\n\t\tpath.pop();\n\t\tpath_str = path.join(\"/\");\n\n\t\tif (manifest.item)\n\t\t{\n\t\t\tfor (i = 0, len = manifest.item.length; i < len; i++)\n\t\t\t{\n\t\t\t\tif (manifest.item[i]['@'])\n\t\t\t\t{\n\t\t\t\t\telement = manifest.item[i]['@'];\n\n\t\t\t\t\telement = this._Elem(element);\n\n\t\t\t\t\tif (element.href && element.href.substr(0, path_str.length) != path_str)\n\t\t\t\t\t{\n\t\t\t\t\t\telement.href = path.concat([element.href]).join(\"/\");\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.manifest[manifest.item[i]['@'].id] = element;\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t *  EPub#parseSpine() -> undefined\n\t *\n\t *  Parses \"spine\" block (all html elements that are shown to the reader)\n\t **/\n\tparseSpine(spine)\n\t{\n\t\tvar i, len, path = this.rootFile.split(\"/\"), element;\n\t\tpath.pop();\n\n\t\tif (spine['@'] && spine['@'].toc)\n\t\t{\n\t\t\tthis.spine.toc = this.manifest[spine['@'].toc] || null;\n\t\t}\n\n\t\tif (spine.itemref)\n\t\t{\n\t\t\tif (!Array.isArray(spine.itemref))\n\t\t\t{\n\t\t\t\tspine.itemref = [spine.itemref];\n\t\t\t}\n\t\t\tfor (i = 0, len = spine.itemref.length; i < len; i++)\n\t\t\t{\n\t\t\t\tif (spine.itemref[i]['@'])\n\t\t\t\t{\n\t\t\t\t\tif (element = this.manifest[spine.itemref[i]['@'].idref])\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.spine.contents.push(element);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.flow = this.spine.contents;\n\t}\n\n\t/**\n\t *  EPub#parseTOC() -> undefined\n\t *\n\t *  Parses ncx file for table of contents (title, html file)\n\t **/\n\tparseTOC()\n\t{\n\t\tvar i, len, path = this.spine.toc.href.split(\"/\"), id_list = {}, keys;\n\t\tpath.pop();\n\n\t\tkeys = Object.keys(this.manifest);\n\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t{\n\t\t\tid_list[this.manifest[keys[i]].href] = keys[i];\n\t\t}\n\n\t\tconst xml2jsOptions = this._getStatic().xml2jsOptions;\n\n\t\tthis.zip.readFile(this.spine.toc.href,  (err, data) =>\n\t\t{\n\t\t\tif (err)\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Reading archive failed\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar xml = data.toString(\"utf-8\"),\n\t\t\t\txmlparser = new xml2js.Parser(xml2jsOptions);\n\n\t\t\txmlparser.on(\"end\", (result) =>\n\t\t\t{\n\t\t\t\tif (result.navMap && result.navMap.navPoint)\n\t\t\t\t{\n\t\t\t\t\tthis.toc = this.walkNavMap(result.navMap.navPoint, path, id_list);\n\t\t\t\t}\n\n\t\t\t\tthis.emit(\"end\");\n\t\t\t});\n\n\t\t\txmlparser.on(\"error\", (err) =>\n\t\t\t{\n\t\t\t\tthis.emit(\"error\", new Error(\"Parsing container XML failed\"));\n\t\t\t\treturn;\n\t\t\t});\n\n\t\t\txmlparser.parseString(xml);\n\n\t\t});\n\t}\n\n\t/**\n\t *  EPub#walkNavMap(branch, path, id_list,[, level]) -> Array\n\t *  - branch (Array | Object): NCX NavPoint object\n\t *  - path (Array): Base path\n\t *  - id_list (Object): map of file paths and id values\n\t *  - level (Number): deepness\n\t *\n\t *  Walks the NavMap object through all levels and finds elements\n\t *  for TOC\n\t **/\n\twalkNavMap(branch, path, id_list, level?: number, pe?: TocElement, parentNcx?: INcxTree, ncx_idx?)\n\t{\n\t\tncx_idx = ncx_idx || {\n\t\t\tindex: 0,\n\t\t};\n\n\t\tlevel = level || 0;\n\n\t\tthis.ncx_depth = Math.max(level + 1, this.ncx_depth || 0);\n\n\t\t// don't go too far\n\t\tif (level > 7)\n\t\t{\n\t\t\treturn [];\n\t\t}\n\n\t\tvar output = [];\n\n\t\tif (!Array.isArray(branch))\n\t\t{\n\t\t\tbranch = [branch];\n\t\t}\n\n\t\tthis.ncx = this.ncx || [];\n\n\t\tfor (var i = 0; i < branch.length; i++)\n\t\t{\n\t\t\tlet element: TocElement;\n\t\t\tlet currentNcx;\n\n\t\t\tif (branch[i].navLabel)\n\t\t\t{\n\t\t\t\tvar title = '';\n\t\t\t\tif (branch[i].navLabel && typeof branch[i].navLabel.text == 'string')\n\t\t\t\t{\n\t\t\t\t\t/*\n\t\t\t\t\ttitle = branch[i].navLabel && branch[i].navLabel.text || branch[i].navLabel === branch[i].navLabel\n\t\t\t\t\t\t? ''\n\t\t\t\t\t\t: (branch[i].navLabel && branch[i].navLabel.text || branch[i].navLabel || \"\").trim();\n\t\t\t\t\t*/\n\n\t\t\t\t\ttitle = (branch[i].navLabel && branch[i].navLabel.text || branch[i].navLabel || \"\").trim();\n\t\t\t\t}\n\t\t\t\tvar order = Number(branch[i][\"@\"] && branch[i][\"@\"].playOrder || 0);\n\t\t\t\tif (isNaN(order))\n\t\t\t\t{\n\t\t\t\t\torder = 0;\n\t\t\t\t}\n\t\t\t\tvar href = '';\n\t\t\t\tif (branch[i].content && branch[i].content[\"@\"] && typeof branch[i].content[\"@\"].src == 'string')\n\t\t\t\t{\n\t\t\t\t\thref = branch[i].content[\"@\"].src.trim();\n\t\t\t\t}\n\n\t\t\t\telement = {\n\t\t\t\t\tlevel: level,\n\t\t\t\t\torder: order,\n\t\t\t\t\ttitle: title\n\t\t\t\t};\n\n\t\t\t\tif (href)\n\t\t\t\t{\n\t\t\t\t\thref = path.concat([href]).join(\"/\");\n\t\t\t\t\telement.href = href;\n\n\t\t\t\t\tif (id_list[element.href])\n\t\t\t\t\t{\n\t\t\t\t\t\t// link existing object\n\t\t\t\t\t\telement = this.manifest[id_list[element.href]];\n\n\t\t\t\t\t\telement.title = title;\n\t\t\t\t\t\telement.order = order;\n\t\t\t\t\t\telement.level = level;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// use new one\n\t\t\t\t\t\telement.href = href;\n\t\t\t\t\t\telement.id = (branch[i][\"@\"] && branch[i][\"@\"].id || \"\").trim();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (level == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet idx = this.ncx.length;\n\n\t\t\t\t\t\tcurrentNcx = this.ncx[idx] = {\n\t\t\t\t\t\t\tid: element.id,\n\t\t\t\t\t\t\tncx_index: idx,\n\t\t\t\t\t\t\tncx_index2: ncx_idx.index++,\n\t\t\t\t\t\t\tlevel,\n\t\t\t\t\t\t\tsub: [],\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\telse if (parentNcx)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet idx = parentNcx.sub.length;\n\n\t\t\t\t\t\tcurrentNcx = parentNcx.sub[parentNcx.sub.length] = {\n\t\t\t\t\t\t\tid: element.id,\n\t\t\t\t\t\t\tncx_index: idx,\n\t\t\t\t\t\t\tncx_index2: ncx_idx.index++,\n\t\t\t\t\t\t\tlevel,\n\t\t\t\t\t\t\tsub: [],\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\toutput.push(element);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//console.log(ncx_idx);\n\n\t\t\tif (branch[i].navPoint)\n\t\t\t{\n\t\t\t\toutput = output.concat(this.walkNavMap(branch[i].navPoint, path, id_list, level + 1, element, currentNcx, ncx_idx));\n\t\t\t}\n\t\t}\n\t\treturn output;\n\t}\n\n\t/**\n\t *  EPub#getChapter(id, callback) -> undefined\n\t *  - id (String): Manifest id value for a chapter\n\t *  - callback (Function): callback function\n\t *\n\t *  Finds a chapter text for an id. Replaces image and link URL's, removes\n\t *  <head> etc. elements. Return only chapters with mime type application/xhtml+xml\n\t **/\n\tgetChapter(chapterId: string, callback: (error: Error, text?: string) => void)\n\t{\n\t\tlet self = this;\n\n\t\tthis.getChapterRaw(chapterId, (err, str) =>\n\t\t{\n\t\t\tif (err)\n\t\t\t{\n\t\t\t\tcallback(err);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet meta = self.manifest[chapterId];\n\n\t\t\tvar i, len, path = this.rootFile.split(\"/\"), keys = Object.keys(this.manifest);\n\t\t\tpath.pop();\n\n\t\t\tlet basePath = pathDirname(meta.href);\n\t\t\tlet baseHref = meta.href;\n\n\t\t\t// remove linebreaks (no multi line matches in JS regex!)\n\t\t\tstr = str.replace(/\\r?\\n/g, \"\\u0000\");\n\n\t\t\t// keep only <body> contents\n\t\t\t// @ts-ignore\n\t\t\tstr.replace(/<body[^>]*?>(.*)<\\/body[^>]*?>/i, function (o, d)\n\t\t\t{\n\t\t\t\tstr = d.trim();\n\t\t\t});\n\n\t\t\t// remove <script> blocks if any\n\t\t\tstr = str.replace(/<script[^>]*?>(.*?)<\\/script[^>]*?>/ig, function (o, s)\n\t\t\t{\n\t\t\t\treturn \"\";\n\t\t\t});\n\n\t\t\t// remove <style> blocks if any\n\t\t\tstr = str.replace(/<style[^>]*?>(.*?)<\\/style[^>]*?>/ig, function (o, s)\n\t\t\t{\n\t\t\t\treturn \"\";\n\t\t\t});\n\n\t\t\t// remove onEvent handlers\n\t\t\tstr = str.replace(/(\\s)(on\\w+)(\\s*=\\s*[\"']?[^\"'\\s>]*?[\"'\\s>])/g, function (o, a, b, c)\n\t\t\t{\n\t\t\t\treturn a + \"skip-\" + b + c;\n\t\t\t});\n\n\t\t\t// replace images\n\t\t\tstr = str.replace(/(?<=\\s|^)(src\\s*=\\s*)([\"']?)([^\"'\\n]*?)(\\2)/g, (o, a, d, b, c) => {\n\n\t\t\t\tlet img = posix.join(basePath, b);\n\t\t\t\tlet element;\n\n\t\t\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t\t\t{\n\t\t\t\t\tlet _arr = [\n\t\t\t\t\t\tself.manifest[keys[i]].href,\n\t\t\t\t\t\tdecodeURI(self.manifest[keys[i]].href),\n\t\t\t\t\t\tencodeURI(self.manifest[keys[i]].href),\n\t\t\t\t\t];\n\n\t\t\t\t\tif (_arr.includes(img))\n\t\t\t\t\t{\n\t\t\t\t\t\telement = self.manifest[keys[i]];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (element)\n\t\t\t\t{\n\t\t\t\t\tlet s = a + d + urlResolve(this.imageroot, img) + c;\n\n\t\t\t\t\treturn s\n\t\t\t\t}\n\n\t\t\t\treturn o;\n\t\t\t});\n\t\t\t/*\n\t\t\tstr = str.replace(/(\\ssrc\\s*=\\s*[\"']?)([^\"'\\s>]*?)([\"'\\s>])/g, (function (o, a, b, c)\n\t\t\t{\n\t\t\t\tvar img = path.concat([b]).join(\"/\").trim(),\n\t\t\t\t\telement;\n\n\t\t\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t\t\t{\n\t\t\t\t\tif (this.manifest[keys[i]].href == img)\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.manifest[keys[i]];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// include only images from manifest\n\t\t\t\tif (element)\n\t\t\t\t{\n\t\t\t\t\treturn a + this.imageroot + element.id + \"/\" + img + c;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\n\t\t\t}).bind(this));\n\t\t\t*/\n\n\t\t\t// replace links\n\t\t\tstr = str.replace(/(\\shref\\s*=\\s*[\"']?)([^\"'\\s>]*?)([\"'\\s>])/g, (o, a, b, c) =>\n\t\t\t{\n\t\t\t\tvar linkparts = b && b.split(\"#\"),\n\t\t\t\t\tlink = path.concat([(linkparts.shift() || \"\")]).join(\"/\").trim(),\n\t\t\t\t\telement;\n\n\t\t\t\tfor (i = 0, len = keys.length; i < len; i++)\n\t\t\t\t{\n\t\t\t\t\tif (this.manifest[keys[i]].href.split(\"#\")[0] == link)\n\t\t\t\t\t{\n\t\t\t\t\t\telement = this.manifest[keys[i]];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (linkparts.length)\n\t\t\t\t{\n\t\t\t\t\tlink += \"#\" + linkparts.join(\"#\");\n\t\t\t\t}\n\n\t\t\t\t// include only images from manifest\n\t\t\t\tif (element)\n\t\t\t\t{\n\t\t\t\t\treturn a + this.linkroot + element.id + \"/\" + link + c;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn a + b + c;\n\t\t\t\t}\n\n\t\t\t});\n\n\t\t\t// bring back linebreaks\n\t\t\tstr = str.replace(/\\u0000/g, \"\\n\").trim();\n\n\t\t\tcallback(null, str);\n\t\t});\n\t}\n\n\t/**\n\t *  EPub#getChapterRaw(id, callback) -> undefined\n\t *  - id (String): Manifest id value for a chapter\n\t *  - callback (Function): callback function\n\t *\n\t *  Returns the raw chapter text for an id.\n\t **/\n\tgetChapterRaw(chapterId: string, callback: (error: Error, text?: string) => void)\n\t{\n\t\tif (this.manifest[chapterId])\n\t\t{\n\t\t\tif (!(this.manifest[chapterId]['media-type'] == \"application/xhtml+xml\" || this.manifest[chapterId]['media-type'] == \"image/svg+xml\"))\n\t\t\t{\n\t\t\t\treturn callback(new Error(`Invalid mime type for chapter \"${chapterId}\" ${this.manifest[chapterId]['media-type']}`));\n\t\t\t}\n\n\t\t\tthis.zip.readFile(this.manifest[chapterId].href, (function (this: EPub, err, data)\n\t\t\t{\n\t\t\t\tif (err)\n\t\t\t\t{\n\t\t\t\t\tcallback(new Error(`Reading archive failed \"${chapterId}\", ${this.manifest[chapterId].href}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\telse if (!data)\n\t\t\t\t{\n\t\t\t\t\tcallback(new Error(`Reading archive failed \"${chapterId}\", ${this.manifest[chapterId].href}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcallback(null, crlf(data.toString(\"utf-8\")));\n\n\t\t\t}).bind(this));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcallback(new Error(`File not found \"${chapterId}\"`));\n\t\t}\n\t}\n\n\t/**\n\t *  EPub#getImage(id, callback) -> undefined\n\t *  - id (String): Manifest id value for an image\n\t *  - callback (Function): callback function\n\t *\n\t *  Finds an image for an id. Returns the image as Buffer. Callback gets\n\t *  an error object, image buffer and image content-type.\n\t *  Return only images with mime type image\n\t **/\n\tgetImage(id: string, callback: (error: Error, data?: Buffer, mimeType?: string) => void)\n\t{\n\t\tif (this.manifest[id])\n\t\t{\n\n\t\t\tif ((this.manifest[id]['media-type'] || \"\").toLowerCase().trim().substr(0, 6) != \"image/\")\n\t\t\t{\n\t\t\t\treturn callback(new Error(\"Invalid mime type for image\"));\n\t\t\t}\n\n\t\t\tthis.getFile(id, callback);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcallback(new Error(\"File not found\"));\n\t\t}\n\t}\n\n\t/**\n\t *  EPub#getFile(id, callback) -> undefined\n\t *  - id (String): Manifest id value for a file\n\t *  - callback (Function): callback function\n\t *\n\t *  Finds a file for an id. Returns the file as Buffer. Callback gets\n\t *  an error object, file contents buffer and file content-type.\n\t **/\n\tgetFile(id: string, callback: (error: Error, data?: Buffer, mimeType?: string) => void)\n\t{\n\t\tif (this.manifest[id])\n\t\t{\n\t\t\tlet self = this;\n\n\t\t\tthis.zip.readFile(this.manifest[id].href, (err, data) =>\n\t\t\t{\n\t\t\t\tif (err)\n\t\t\t\t{\n\t\t\t\t\tcallback(new Error(`Reading archive failed ${self.manifest[id].href}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcallback(null, data, this.manifest[id]['media-type']);\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcallback(new RangeError(`File not found \"${id}\"`));\n\t\t}\n\t}\n\n\treadFile(filename, options, callback_)\n\t{\n\t\tlet callback = arguments[arguments.length - 1];\n\n\t\tif (typeof options === 'function' || !options)\n\t\t{\n\t\t\tthis.zip.readFile(filename, callback);\n\t\t}\n\t\telse if (typeof options === 'string')\n\t\t{\n\t\t\t// options is an encoding\n\t\t\tthis.zip.readFile(filename, function (err, data)\n\t\t\t{\n\t\t\t\tif (err)\n\t\t\t\t{\n\t\t\t\t\tcallback(new Error(`Reading archive failed ${filename}`));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tcallback(null, data.toString(options as any));\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthrow new TypeError('Bad arguments');\n\t\t}\n\t}\n\n\tstatic SYMBOL_RAW_DATA = SYMBOL_RAW_DATA;\n\n\tstatic readonly IMAGE_ROOT = '/images/';\n\tstatic readonly LINK_ROOT = '/links/';\n\n\tstatic readonly ELEM_MEDIA_TYPE = 'media-type';\n\tstatic readonly ELEM_MEDIA_TYPE2 = 'mediaType';\n\n\tstatic xml2jsOptions = Object.assign({}, xml2js.defaults['0.1']) as xml2js.Options;\n}\n\nexport default EPub\n"]}