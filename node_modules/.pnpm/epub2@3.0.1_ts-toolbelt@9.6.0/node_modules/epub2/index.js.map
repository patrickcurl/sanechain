{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":";AAAA;;GAEG;;;;AAEH,gEAA+B;AAC/B,wDAAwB;AAGxB,qCAA6C;AAG7C,qCAA8C;AAArC,wGAAA,eAAe,OAAA;AAExB,MAAa,IAAK,SAAQ,WAAO;IAEhC,MAAM,CAAC,WAAW,CAAC,QAAgB,EAAE,YAAqB,EAAE,cAAuB,EAAE,GAAG,IAAI;QAE3F,MAAM,IAAI,GAAG,IAAI,CAAC;QAClB,MAAM,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC;QAE1B,OAAO,IAAI,CAAC,CAAC,UAAU,OAAO,EAAE,MAAM;YAErC,MAAM,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,YAAY,EAAE,cAAc,EAAE,GAAG,IAAI,CAAC,CAAC;YAE1E,MAAM,MAAM,GAAG,UAAU,GAAG;gBAE3B,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC;gBAChB,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC;YACpB,CAAC,CAAC;YAEF,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;YACzB,IAAI,CAAC,EAAE,CAAC,KAAK,EAAE,UAAU,GAAG;gBAE3B,IAAI,GAAG,EACP;oBACC,MAAM,CAAC,GAAG,CAAC,CAAC;iBACZ;qBAED;oBACC,aAAa;oBACb,OAAO,CAAC,IAAI,CAAC,CAAC;iBACd;YACF,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,KAAK,EAAE,CAAC;QACd,CAAC,CAAC,CAAC;IACJ,CAAC;IAES,YAAY,CAAI,MAAM,EAAE,UAAmC,EAAE,EAAE,GAAG,IAAI;QAE/E,MAAM,IAAI,GAAG,IAAI,CAAC;QAClB,MAAM,CAAC,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC,UAAU,CAAC;QAEvC,OAAO,kBAAO,CAAC,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,EAAE,OAAO,CAAC,CAAC;IAC/D,CAAC;IAEM,eAAe,CAAC,SAAiB;QAEvC,OAAO,IAAI,CAAC,YAAY,CAAS,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;IACpE,CAAC;IAEM,kBAAkB,CAAC,SAAiB;QAE1C,OAAO,IAAI,CAAC,YAAY,CAAS,IAAI,CAAC,aAAa,EAAE,IAAI,EAAE,SAAS,CAAC,CAAC;IACvE,CAAC;IAEM,YAAY,CAAC,EAAU;QAE7B,OAAO,IAAI,CAAC,YAAY,CAAmB,IAAI,CAAC,OAAO,EAAE;YACxD,SAAS,EAAE,IAAI;SACf,EAAE,EAAE,CAAC,CAAC;IACR,CAAC;IAEM,aAAa,CAAC,EAAU;QAE9B,OAAO,IAAI,CAAC,YAAY,CAAmB,IAAI,CAAC,QAAQ,EAAE;YACzD,SAAS,EAAE,IAAI;SACf,EAAE,EAAE,CAAC,CAAC;IACR,CAAC;IAED,SAAS;QAER,MAAM,IAAI,GAAG,IAAI,CAAC;QAClB,MAAM,KAAK,GAAG;YACb,YAAY;SACZ,CAAC;QACF,MAAM,IAAI,GAAG;YACZ,KAAK;YACL,KAAK;YACL,KAAK;YACL,MAAM;YACN,KAAK;YACL,KAAK;YACL,QAAQ;YACR,OAAO;SACP,CAAC;QAEF,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC/B,MAAM,CAAC,UAAU,CAAC,EAAE,EAAE;YAEtB,IAAI,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;YAC7B,IAAI,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC,SAAS,CAAC;YAEhD,IAAI,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,cAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,EAChG;gBACC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;aACZ;YAED,OAAO,CAAC,CAAC;QACV,CAAC,EAAE,EAAE,CAAC,CACL;IACH,CAAC;;AAlGF,oBA6GC;AATgB,kBAAa,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,WAAO,CAAC,aAAa,EAAE;IACxE,SAAS,EAAE,IAAI;CACf,CAAmB,CAAC;AAErB;;;GAGG;AACI,eAAU,GAAG,kBAAO,CAAC;AAG7B,kBAAe,IAAI,CAAC","sourcesContent":["/**\n * Created by user on 2018/2/1/001.\n */\n\nimport Promise from 'bluebird';\nimport path from 'path';\nimport xml2js from 'xml2js';\n\nimport { EPub as libEPub } from './lib/epub';\nimport { TocElement } from './lib/epub/const';\n\nexport { SYMBOL_RAW_DATA } from './lib/types';\n\nexport class EPub extends libEPub\n{\n\tstatic createAsync(epubfile: string, imagewebroot?: string, chapterwebroot?: string, ...argv): Promise<EPub>\n\t{\n\t\tconst self = this;\n\t\tconst p = self.libPromise;\n\n\t\treturn new p(function (resolve, reject)\n\t\t{\n\t\t\tconst epub = self.create(epubfile, imagewebroot, chapterwebroot, ...argv);\n\n\t\t\tconst cb_err = function (err)\n\t\t\t{\n\t\t\t\terr.epub = epub;\n\t\t\t\treturn reject(err);\n\t\t\t};\n\n\t\t\tepub.on('error', cb_err);\n\t\t\tepub.on('end', function (err)\n\t\t\t{\n\t\t\t\tif (err)\n\t\t\t\t{\n\t\t\t\t\tcb_err(err);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\tresolve(this);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tepub.parse();\n\t\t});\n\t}\n\n\tprotected _p_method_cb<T>(method, options: Promise.FromNodeOptions = {}, ...argv): Promise<T>\n\t{\n\t\tconst self = this;\n\t\tconst p = this._getStatic().libPromise;\n\n\t\treturn Promise.fromCallback(method.bind(self, argv), options);\n\t}\n\n\tpublic getChapterAsync(chapterId: string)\n\t{\n\t\treturn this._p_method_cb<string>(this.getChapter, null, chapterId);\n\t}\n\n\tpublic getChapterRawAsync(chapterId: string)\n\t{\n\t\treturn this._p_method_cb<string>(this.getChapterRaw, null, chapterId);\n\t}\n\n\tpublic getFileAsync(id: string)\n\t{\n\t\treturn this._p_method_cb<[Buffer, string]>(this.getFile, {\n\t\t\tmultiArgs: true,\n\t\t}, id);\n\t}\n\n\tpublic getImageAsync(id: string)\n\t{\n\t\treturn this._p_method_cb<[Buffer, string]>(this.getImage, {\n\t\t\tmultiArgs: true,\n\t\t}, id);\n\t}\n\n\tlistImage(): TocElement[]\n\t{\n\t\tconst epub = this;\n\t\tconst mimes = [\n\t\t\t'image/jpeg',\n\t\t];\n\t\tconst exts = [\n\t\t\t'jpg',\n\t\t\t'png',\n\t\t\t'gif',\n\t\t\t'webp',\n\t\t\t'tif',\n\t\t\t'bmp',\n\t\t\t//'jxr',\n\t\t\t//'psd'\n\t\t];\n\n\t\treturn Object.keys(epub.manifest)\n\t\t\t.reduce(function (a, id)\n\t\t\t{\n\t\t\t\tlet elem = epub.manifest[id];\n\t\t\t\tlet mime = elem['media-type'] || elem.mediaType;\n\n\t\t\t\tif (mimes.includes(mime) || mime.indexOf('image') == 0 || exts.includes(path.extname(elem.href)))\n\t\t\t\t{\n\t\t\t\t\ta.push(elem)\n\t\t\t\t}\n\n\t\t\t\treturn a;\n\t\t\t}, [])\n\t\t\t;\n\t}\n\n\tstatic override xml2jsOptions = Object.assign({}, libEPub.xml2jsOptions, {\n\t\tnormalize: null,\n\t}) as xml2js.Options;\n\n\t/**\n\t * allow change Promise class\n\t * @type {PromiseConstructor}\n\t */\n\tstatic libPromise = Promise;\n}\n\nexport default EPub;\n"]}